var myData = { Rows:[
    {"xmbh": '010100X201201006', "xmmc": "瑞星家园中学食堂", "yjzt": 2, "xmdz":"长安", "jsdw":"无锡市住房保障建设发展有限公司", "xmxz": 2, "slsj":"2012年11月21日", "slr":"王颖", "slck":"00", "xmzt": 3, "sbcl": 1, "hsfy": 1064.6, "ysfy": 1064.6, "dzje": 1064.6, "sfrq":"2010年08月19日", "sfzt": 1},
    {"xmbh": '010100X201033105', "xmmc": "车间2#、3#", "yjzt": 2, "xmdz":"金惠路南侧", "jsdw":"德新钢管（中国）有限公司", "xmxz": 1, "slsj":"2012年11月02日", "slr":"朱荣林", "slck":"30", "xmzt": 3, "sbcl": 1, "hsfy": 9613.5, "ysfy": 9613.5, "dzje": 9613.5, "sfrq":"2010年10月28日", "sfzt": 1},
    {"xmbh": '010100X201133059', "xmmc": "工业研发中心", "yjzt": 3, "xmdz":"瑞星家园小学内", "jsdw":"德新钢管（中国）有限公司", "xmxz": 2, "slsj":"2012年11月07日", "slr":"朱荣林", "slck":"30", "xmzt": 3, "sbcl": 1, "hsfy":4789.6, "ysfy": 4789.6, "dzje": 4789.6, "sfrq":"2011年06月07日", "sfzt": 2},
    {"xmbh": '010100X201211065', "xmmc": "瑞星家园小学食堂", "yjzt": 2, "xmdz":"无锡广益路9号", "jsdw":"无锡市住房保障建设发展有限公司", "xmxz": 1, "slsj":"2012年11月06日", "slr":"岳擎宇", "slck":"10", "xmzt": 3, "sbcl": 2, "hsfy":0, "ysfy": 0, "dzje": 0, "sfrq":"", "sfzt": 2},
    {"xmbh": '010100X201211066', "xmmc": "观庭11#、14#", "yjzt": 1, "xmdz":"锡山区友谊北路300号", "jsdw":"无锡市金科房地产开发有限公司", "xmxz": 1, "slsj":"2012年11月06日", "slr":"岳擎宇", "slck":"10", "xmzt": 3, "sbcl": 2, "hsfy":0, "ysfy": 0, "dzje": 0, "sfrq":"", "sfzt": 2},
    {"xmbh": '010100X201222040', "xmmc": "皮革馆", "yjzt": 1, "xmdz":"盛岸西路590-592号", "jsdw":"无锡东方国际轻纺城集团有限公司", "xmxz": 3, "slsj":"2012年11月02日", "slr":"李德林", "slck":"20", "xmzt": 3, "sbcl": 1, "hsfy":0, "ysfy": 0, "dzje": 0, "sfrq":"", "sfzt": 1},
    {"xmbh": '010100X201233064', "xmmc": "金属制品交易中心", "yjzt": 3, "xmdz":"堰桥", "jsdw":"江苏钱桥金属制品交易中心有限公司", "xmxz": 3, "slsj":"2012年11月07日", "slr":"朱荣林", "slck":"30", "xmzt": 3, "sbcl": 1, "hsfy":62061.6, "ysfy":62061.6, "dzje": 62061.6, "sfrq":"2012年08月15日", "sfzt": 1},
    {"xmbh": '010100X201233087', "xmmc": "应急指挥中心", "yjzt": 2, "xmdz":"惠山区玉祁街道曙光路西", "jsdw":"无锡市公安局惠山分局", "xmxz": 3, "slsj":"2012年11月02日", "slr":"朱荣林", "slck":"30", "xmzt": 3, "sbcl": 1, "hsfy":3494.5, "ysfy":3494.5, "dzje": 3494.5, "sfrq":"2012年10月25日", "sfzt": 1},
    {"xmbh": '010100X201233089', "xmmc": "湖畔花城二期A区1#、28#", "yjzt": 2, "xmdz":"洛社", "jsdw":"无锡玉祁宝龙置业有限公司", "xmxz": 4, "slsj":"2012年11月02日", "slr":"朱荣林", "slck":"30", "xmzt": 3, "sbcl": 2, "hsfy":3752.48, "ysfy":3752.48, "dzje": 3752.48, "sfrq":"2012年11月02日", "sfzt": 2},
    {"xmbh": '010100X201233090', "xmmc": "洛社新城7#B地块商业及商务办公用房", "yjzt": 1, "xmdz":"西新路南", "jsdw":"江苏华广置业有限公司", "xmxz": 4, "slsj":"2012年11月07日", "slr":"朱荣林", "slck":"30", "xmzt": 3, "sbcl": 2, "hsfy":31360, "ysfy":31360, "dzje": 31360, "sfrq":"2012年11月07日", "sfzt": 1},
    {"xmbh": '010100X201233091', "xmmc": "御景名仕园（一期）", "yjzt": 2, "xmdz":"新区吴都路以南,宏铭公司以东", "jsdw":"无锡市康达房产置业有限公司", "xmxz": 2, "slsj":"2012年11月07日", "slr":"朱荣林", "slck":"50", "xmzt": 3, "sbcl": 1, "hsfy":32017.85, "ysfy":32017.85, "dzje": 32017.85, "sfrq":"2012年11月07日", "sfzt": 1},
    {"xmbh": '010100X201255051', "xmmc": "新建厂区", "yjzt": 1, "xmdz": "江海东路高架西侧广益街道丁村管巷地块", "jsdw":"菲尼萨光电通讯科技(无锡)有限公司", "xmxz": 1, "slsj":"2012年11月02日", "slr":"王春芳", "slck":"50", "xmzt": 3, "sbcl": 1, "hsfy":0, "ysfy":0, "dzje": 0, "sfrq":"", "sfzt": 1},
    {"xmbh": '010100X201261031', "xmmc": "广益景苑二期安置房项目", "yjzt": 1, "xmdz":"经济开发区团结大道东,二泉东路南,新园路西,东安路北", "jsdw":"无锡市广益建设发展集团有限公司", "xmxz": 1, "slsj":"2012年11月01日", "slr":"崔浩", "slck": 1, "xmzt": 3, "sbcl":"", "hsfy":0, "ysfy":0, "dzje": 0, "sfrq":"", "sfzt": 2},
    {"xmbh": '010100X201262032', "xmmc": "英特宜家无锡购物中心", "yjzt": 2, "xmdz":"锡山区锡沪中路", "jsdw":"无锡英特宜家置业有限公司", "xmxz": 2, "slsj":"2012年11月02日", "slr":"崔浩", "slck":"60", "xmzt": 3, "sbcl": 2, "hsfy":0, "ysfy":0, "dzje": 0, "sfrq":"", "sfzt": 1},
    {"xmbh": '010100X201262033', "xmmc": "易买得西地块项目一期洋房", "yjzt": 3, "xmdz":"锡山区锡沪北路", "jsdw":"无锡嘉睿置业有限公司", "xmxz": 1, "slsj":"2012年11月05日", "slr":"崔浩", "slck":"60", "xmzt": 3, "sbcl": 2, "hsfy":0, "ysfy":0, "dzje": 0, "sfrq":"", "sfzt": 1}
], Total:15 };

//var gridColumns = [
//    {columnName: 'xmbh', displayState: '', displayName: '项目编号', columnWidth: 130, columnMinWidth: 100,  alignType: '', columnType: '', disableSort: false},
//    {columnName: 'xmmc', displayState: '', displayName: '项目名称', columnWidth: 130, columnMinWidth: 100,  alignType: 'left', columnType: '', disableSort: false},
//    {columnName: 'jsdw', displayState: '', displayName: '单位名称', columnWidth: 200, columnMinWidth: 120,  alignType: 'left', columnType: '', disableSort: false},
//    {columnName: 'xmdz', displayState: '', displayName: '项目地址', columnWidth: 250, columnMinWidth: 120,  alignType: 'left', columnType: '', disableSort: true},
//    {columnName: 'xmxz', displayState: '', displayName: '项目性质', columnWidth: 70, columnMinWidth: 60, alignType: '', columnType: '', disableSort: false},
//    {columnName: 'slsj', displayState: '', displayName: '受理时间', columnWidth: 110, columnMinWidth: 100,  alignType: '', columnType: '', disableSort: false},
//    {columnName: 'slr',  displayState: '', displayName: '受理人',   columnWidth: 70, columnMinWidth: 60,  alignType: '', columnType: '', disableSort: true},
//    {columnName: 'slck', displayState: '', displayName: '受理窗口', columnWidth: 70, columnMinWidth: 60, alignType: '', columnType: '', disableSort: true},
//    {columnName: 'xmzt', displayState: '', displayName: '项目状态', columnWidth: 90, columnMinWidth: 70, alignType: '', columnType: '', disableSort: true}
//];
var gridColumns = [
    {display: '项目编号', name: 'xmbh', width: 130, minWidth: 100},
    {display: '项目名称1', name: 'xmmc', align: 'left', width: 200, minWidth: 120},
    {display: '单位名称', name: 'jsdw', align: 'left', width: 250, minWidth: 120, isSort: false},
    {display: '项目地址', name: 'xmdz', align: 'left', width: 200, minWidth: 120, isSort: false},
    {display: '项目性质', name: 'xmxz', width: 70, minWidth: 60},
    {display: '受理时间', name: 'slsj', width: 110, minWidth: 100},
    {display: '受理人', name: 'slr', width: 70, minWidth: 60, isSort: false},
    {display: '受理窗口', name: 'slck', width: 70, minWidth: 60, isSort: false},
    {display: '项目状态', name: 'xmzt', width: 90, minWidth: 70, isSort: false}
];

var columnTypeData = [
    {value: '', text: '文本'},
    {value: 'date', text: '日期'},
    {value: 'percent', text: '百分比'},
    {value: 'numberBox', text: '数字'},
    {value: 'currency', text: '货币'}
];

var alignTypeData = [
    {value: 'center', text: '居中'},
    {value: 'left', text: '居右'},
    {value: 'right', text: '居左'}
];

var columnStateData = [
    {value: '', text: '正常'},
    {value: 'frozen', text: '固定'},
    {value: 'hidden', text: '隐藏'},
    {value: 'disabled', text: '禁用'}
];

$.ligerDefaults.Grid.editors['select'] = {
    create: function (container, editParm) {
        var column = editParm.column;
        var input = $("<select></select>");
        container.append(input);
        var data = column.editor.data;
        if (!data) return input;
        $(data).each(function () {
            input.append('<option value="' + this.value + '">' + (this.text || this.name) + '</option>');
        });
        return input;
    },
    getValue: function (input, editParm) {
        return input.val();
    },
    setValue: function (input, value, editParm) {
        if (value) {
            input.val(value);
        }
    },
    resize: function (input, width, height, editParm) {
        input.css({ width: width, height: 22 });
    }
};

$(document).ready(function() {
    bulidMainGrid();
});

function bulidMainGrid() {
    var designerGridColumns = parseGridColumnData(gridColumns);
    PAGE_UTIL.customGrid = $('#mainGrid').ligerGrid({
        columns: [
            {display: '基本信息', columns: [
                {display: '字段名', name: 'columnName', align: 'left', isSort: false, width: 110, minWidth: 70},
                {display: '显示名', name: 'displayName', align: 'left', isSort: false, width: 110, minWidth: 70, editor: {type: 'text'}},
                {display: '显示状态', name: 'displayState', isSort: false, width: 90, minWidth: 70, editor: {type: 'select', data: columnStateData}, render: columnStateRender}
            ]},
            {display: '列表页设置', columns: [
                {display: '禁用排序', name: 'disableSort', align: 'right', isSort: false, width: 60, render: checkboxRender},
                {display: '对齐方式', name: 'alignType', isSort: false, width: 90, minWidth: 80, editor: {type: 'select', data: alignTypeData}, render: alignTypeRender},
                {display: '显示类型', name: 'columnType', isSort: false, width: 90, minWidth: 80, editor: {type: 'select', data: columnTypeData}, render: columnTypeRender},
                {display: '宽度', name: 'columnWidth', align: 'right', isSort: false, width: 90, minWidth: 80, editor: {type: 'numberBox'}},
                {display: '最小宽度', name: 'columnMinWidth', align: 'right', isSort: false, width: 90, minWidth: 80, editor: {type: 'numberBox'}}
            ]}
        ],
        data: {Rows: designerGridColumns}, usePager: false, checkbox: false, toolbar: createGridToolbar(),
        enabledEdit: true, clickToEdit: true, width: 'auto', height: '99%'
    });
}

function createGridToolbar() {
    var items = [];
    items.push({ text: '预览效果', click: preview, img: "../../css/ligerUI/icons/application_view_list.png" });
    items.push({ text: '导出JSON', click: outJson, img: "../../css/ligerUI/icons/json_16.png" });
    items.push({ text: '上移', click: moveUp, img: "../../css/ligerUI/icons/arrow_up.gif" });
    items.push({ text: '下移', click: moveDown, img: "../../css/ligerUI/icons/arrow_down.gif" });
    return { items: items };

    function clear() {
        var managers = $.ligerui.find($.ligerui.controls.Input);
        for (var i = 0, l = managers.length; i < l; i++) {
            if (exits(managers[i].id)) {
                managers[i].destroy();
            }
        }
    }

    function exits(id) {
        for (var i = 0, l = PAGE_UTIL.customGrid.rows.length; i < l; i++) {
            var name = PAGE_UTIL.customGrid.rows[i].name;
            if (name == id) return true;
        }
        return false;
    }

    function preview() {
        clear();
        var gridColumnsOption = buildGridColumnData();
        var listPanel = $("<div class='listGrid'></div>");

        var listGrid = $(listPanel).ligerGrid({
            columns: gridColumnsOption, toolbar: listToolbar(), data: $.extend(true, {}, myData),
            width: '98%', height: '360', pageSize: 10, pageSizeOptions: [10, 15, 20],checkbox: true
        });

        $.ligerDialog.open({
            title: '预览 列表 界面',
            target: listPanel,
            width: 750, height: 430, isResize: true,
            buttons: [
                { text: '关闭', onclick: function (item, dialog) {
                    dialog.hide();
                }}
            ]
        });
        listGrid._onResize();
        function listToolbar() {
            var items = [];
            items.push({text: '增加', click: grid_add, img: "../../css/ligerUI/icons/add.gif"});
            items.push({text: '修改', click: grid_edit, img: "../../css/ligerUI/icons/edit.gif"});
            items.push({text: '删除', click: grid_delete, img: "../../css/ligerUI/icons/delete.gif"});
            return { items: items };

            function grid_add() {
                PAGE_UTIL.showSuccess("我叫增加");
            }

            function grid_edit() {
                var selected = listGrid.getSelected();
                if (!selected) {
                    PAGE_UTIL.showSuccess("我叫编辑");
                }
            }

            function grid_delete() {
                PAGE_UTIL.showSuccess("我叫编辑", function(){
                    listGrid.deleteSelectedRow();
                });
            }
        }
    }

    function outJson() {
        var gridColumnsOption = buildGridColumnData();
        var textArea = $("<textarea />").width(400).height(200);
        textArea.val($.ligerui.toJSON(gridColumnsOption));
        $.ligerDialog.open({
            title: 'JSON',
            target: textArea.wrap('<div></div>').parent().css('margin', 10),
            width: 470, height: 300, isResize: true,
            buttons: [
                { text: '关闭', onclick: function (item, dialog) {
                    dialog.hide();
                } }
            ]
        });
    }

    function moveUp() {
        var selected = PAGE_UTIL.customGrid.getSelected();
        if (!selected) return;
        PAGE_UTIL.customGrid.up(selected);
    }

    function moveDown() {
        var selected = PAGE_UTIL.customGrid.getSelected();
        if (!selected) return;
        PAGE_UTIL.customGrid.down(selected);
    }
}

function parseGridColumnData(gridColumns) {
    var gridRows = [];
    $.each(gridColumns, function(index, grdiColumn) {
        var row = {
            columnName: this.name,
            displayName: this.display,
            columnWidth: this.width || 100,
            columnMinWidth: this.minWidth || 90,
            alignType: this.align,
            columnType: this.type
        };
        if (undefined !== this.isSort && !this.isSort) {
            row.disableSort = true;
        } else {
            row.disableSort = false;
        }
        if(this.hide) {
            row.displayState = columnStateData[2]['value'];
        } else if (this.frozen) {
            row.displayState = columnStateData[1]['value'];
        } else {
            row.displayState = columnStateData[0]['value'];
        }
        gridRows.push(row);
    });
    return gridRows;
}

//获取 表单和表格 结构 所需要的数据
function buildGridColumnData() {
    var gridData = [];
    var frozenColumnGridData = [];
    $.each(PAGE_UTIL.customGrid.rows, function(index, value) {
        if(columnStateData[3]['value'] !== this.displayState) {
            var gridColumnSetting = {
                display: this.displayName || '名称',
                name: this.columnName,
                width: this.columnWidth || 100,
                minWidth: this.columnMinWidth || 70
            };
            if(this.alignType && alignTypeData[0]['value'] !== this.alignType) {
                gridColumnSetting.align = this.alignType;
            }
            if(this.columnType) {
                gridColumnSetting.type = this.columnType;
            }
            if(this.disableSort) {
                gridColumnSetting.isSort = false;
            }
            if(columnStateData[1]['value'] === this.displayState) {
                gridColumnSetting.frozen = true;
                frozenColumnGridData.push(gridColumnSetting);
            } else {
                if(columnStateData[2]['value'] === this.displayState)  {
                    gridColumnSetting.hide = true;
                }
                gridData.push(gridColumnSetting);
            }
        }
    });
    if(0 < frozenColumnGridData.length) {
        return frozenColumnGridData.concat(gridData);
    } else {
        return gridData;
    }
}

//字段类型渲染器
function columnTypeRender(row, index, value) {
    var type = '';
    if(value) {
        $.each(columnTypeData, function(){
            if(value === this.value) {
                type = this.text;
                return false;
            }
        });
    } else {
        type = columnTypeData[0].text;
    }
    return type;
}
// 对齐方式渲染器
function alignTypeRender(row, index, value) {
    var align = '';
    if(value) {
        $.each(alignTypeData, function(){
            if(value === this.value) {
                align = this.text;
                return false;
            }
        });
    } else {
        align = alignTypeData[0].text;
    }
    return align;
}
// 对齐方式渲染器
function columnStateRender(row, index, value) {
    var align = '';
    if(value) {
        $.each(columnStateData, function(){
            if(value === this.value) {
                align = this.text;
                return false;
            }
        });
    } else {
        align = columnStateData[0].text;
    }
    return align;
}
//是否类型的模拟复选框的渲染函数
function checkboxRender(rowdata, rowindex, value, column) {
    var chkHtml = "<div class='chk-icon";
    if (value) {
        chkHtml += " chk-icon-selected";
    }
    chkHtml += "'";
    chkHtml += " rowid = '" + rowdata["__id"] + "'";
    chkHtml += " gridid = '" + this.id + "'";
    chkHtml += " columnname = '" + column.name + "'";
    chkHtml += "></div>";
    return chkHtml;
}

//是否类型的模拟复选框的点击事件
$("div.chk-icon").live('click', function () {
    var grid = $.ligerui.get($(this).attr("gridid"));
    var rowdata = grid.getRow($(this).attr("rowid"));
    var columnname = $(this).attr("columnname");
    var checked = rowdata[columnname];
    grid.updateCell(columnname, !checked, rowdata);
});